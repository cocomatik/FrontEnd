name: Deploy Static Site to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Setup SSH
        run: |
          echo "ðŸ” Setting up SSH access..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… SSH setup completed."

      - name: ðŸ“¦ Deploy via rsync
        run: |
          echo "ðŸ“¡ Starting rsync to VPS..."
          rsync -avz -e "ssh -p ${{ secrets.SSH_PORT }}" \
            --exclude=".git/" \
            --exclude=".github/" \
            --exclude="README.md" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/dev/COCOMATIK/FrontEnd2
          echo "âœ… Deployment complete."

      - name: ðŸ“ Log & Reload Nginx on VPS
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          UNIQUE_ID=$(openssl rand -hex 8)
          LOG_PATH="/home/dev/COCOMATIK/FrontEnd2/logs/deployment_${UNIQUE_ID}.log"

          echo "ðŸ—‚ï¸ Logging deployment details to $LOG_PATH..."

          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p /home/dev/COCOMATIK/FrontEnd2/logs && \
            echo '----- Deployment at $TIMESTAMP -----' | tee -a $LOG_PATH && \
            echo 'Deployed from GitHub Actions' | tee -a $LOG_PATH && \
            echo 'Restarting Nginx...' | tee -a $LOG_PATH && \
            sudo systemctl reload nginx 2>&1 | tee -a $LOG_PATH && \
            echo 'âœ… Deployment completed at $TIMESTAMP' | tee -a $LOG_PATH && \
            echo '' | tee -a $LOG_PATH"
